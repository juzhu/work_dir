<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=0">
    <title>聚箸</title>
    <link rel="stylesheet" href="./stylesheets/weui.css"/>
    <link rel="stylesheet" href="./stylesheets/example.css"/>
  </head>
  <body ontouchstart>
    <div class="container" id="container">
      <div class="weui_cells weui_cells_form">
        <div class="weui_cells" id="phone_cell">
          <div class="weui_cell weui_cell_select weui_select_before">
            <div class="weui_cell_hd">
              <select class="weui_select" name="select2">
                <option value="1">+86</option>
              </select>
            </div>
            <div class="weui_cell_bd weui_cell_primary">
              <input class="weui_input" type="number" pattern="[0-9]*" placeholder="请输入号码" style="width:70%" id="phone">
              <a href="javascript:getVerifyCode()" class="weui_btn weui_btn_mini weui_btn_primary" id="get_code">验证</a>
            </div>
          </div>
        </div>
        <div class="weui_cell">
          <div class="weui_cell_hd"><label class="weui_label">验证码</label></div>
          <div class="weui_cell_bd weui_cell_primary">
            <input class="weui_input" type="number" pattern="[0-9]*" id='phone_code'placeholder="    请输入六位验证码">
          </div>
        </div>
        <div class="weui_btn_area">
          <a class="weui_btn weui_btn_primary" href="javascript:AddPhoneVerify()" id="showTooltips">确定</a>
        </div>
      </div>
      <div class="weui_media_box weui_media_text">
        <h4 class="weui_media_title">绑定有什么用处</h4>
        <p class="weui_media_desc">绑定之后可实时查看您通过以该手机号在各大外卖平台点餐聚箸的订单情况，以及每个订单产生的积分</p>
        <ul class="weui_media_info">
          <li class="weui_media_info_meta">聚箸</li>
          <li class="weui_media_info_meta">2016-04-12</li>
        </ul>
      </div>
      <script src="./javascripts/zepto.min.js"></script>
      <!--BEGIN dialog2-->
      <div class="weui_dialog_alert" id="dialog2" style="display: none;">
        <div class="weui_mask"></div>
        <div class="weui_dialog">
          <div class="weui_dialog_hd"><strong class="weui_dialog_title">信息缺失</strong></div>
          <div class="weui_dialog_bd">请填写正确的手机号码</div>
          <div class="weui_dialog_ft">
            <a href="javascript:;" class="weui_btn_dialog primary">确定</a>
          </div>
        </div>
      </div>
      <!--END dialog2-->
      <!--BEGIN dialog confirm-->
      <div class="weui_dialog_alert" id="dialog_sms_ok" style="display: none;">
        <div class="weui_mask"></div>
        <div class="weui_dialog">
          <div class="weui_dialog_hd"><strong class="weui_dialog_title">消息</strong></div>
          <div class="weui_dialog_bd" id="sms_dialog_db">短信已经发送，请注意查收短信</div>
          <div class="weui_dialog_ft">
            <a href="javascript:;" class="weui_btn_dialog primary">确定</a>
          </div>
        </div>
      </div>
      <!--BEGIN dialog failed-->


      <!--BEGIN dialog confirm-->
      <div class="weui_dialog_alert" id="dialog_confirm" style="display: none;">
        <div class="weui_mask"></div>
        <div class="weui_dialog">
          <div class="weui_dialog_hd"><strong class="weui_dialog_title">消息</strong></div>
          <div class="weui_dialog_bd">绑定成功</div>
          <div class="weui_dialog_ft">
            <a href="javascript:;" class="weui_btn_dialog primary">确定</a>
          </div>
        </div>
      </div>
      <!--BEGIN dialog failed-->
      <div class="weui_dialog_alert" id="dialog_failed" style="display: none;">
        <div class="weui_mask"></div>
        <div class="weui_dialog">
          <div class="weui_dialog_hd"><strong class="weui_dialog_title">消息</strong></div>
          <div class="weui_dialog_bd">操作失败</div>
          <div class="weui_dialog_ft">
            <a href="javascript:;" class="weui_btn_dialog primary">确定</a>
          </div>
        </div>
      </div>


      <div id="loadingToast" class="weui_loading_toast" style="display:none;">
        <div class="weui_mask_transparent"></div>
        <div class="weui_toast">
          <div class="weui_loading">
            <div class="weui_loading_leaf weui_loading_leaf_0"></div>
            <div class="weui_loading_leaf weui_loading_leaf_1"></div>
            <div class="weui_loading_leaf weui_loading_leaf_2"></div>
            <div class="weui_loading_leaf weui_loading_leaf_3"></div>
            <div class="weui_loading_leaf weui_loading_leaf_4"></div>
            <div class="weui_loading_leaf weui_loading_leaf_5"></div>
            <div class="weui_loading_leaf weui_loading_leaf_6"></div>
            <div class="weui_loading_leaf weui_loading_leaf_7"></div>
            <div class="weui_loading_leaf weui_loading_leaf_8"></div>
            <div class="weui_loading_leaf weui_loading_leaf_9"></div>
            <div class="weui_loading_leaf weui_loading_leaf_10"></div>
            <div class="weui_loading_leaf weui_loading_leaf_11"></div>
          </div>
          <p class="weui_toast_content">数据加载中</p>
        </div>
      </div>
      <script type="text/javascript">

        function getVerifyCode() {
          var phone = $("#phone").val();
          if (phone == "") {
            $("#dialog2").show().on('click', '.weui_btn_dialog', function() {
              $("#dialog2").off('click').hide();
              $("#phone")[0].foucus();
              });
            return;
          } else {
          }
          $('#loadingToast').show();
          $.getJSON("/getVerifyCode?phone=" + phone, function(response) {
            $('#loadingToast').hide();
            if (!(response.err)) {
            $("#sms_dialog_db").text("消息已成功发送至" + phone + " 请注意查收!")
            $("#dialog_sms_ok").show().on('click', '.weui_btn_dialog', function() {
              $("#dialog_sms_ok").off('click').hide();
              var count = 60;
              var countTimer = setInterval(function() {
                if (count > 0) {
                $("#get_code").text(count + "秒");
                $("#get_code").addClass("weui_btn_disabled").removeClass("weui_btn_primary").addClass("weui_btn_default");
                $("#get_code").attr("href", "javascript:");
                } else {
                $("#get_code").text("获取验证码");
                $("#get_code").removeClass("weui_btn_disabled").removeClass("weui_btn_default").addClass("weui_btn_primary");
                $("#get_code").attr("href", "javascript:getVerifyCode()");
                clearInterval(countTimer);
                }
                count--;
                }, 1000);

              });
            } else {
              $("#sms_dialog_db").text("短信发送异常， 请联系客服");
            }
          });
        }

function AddPhoneVerify() {
  var phone = $("#phone").val();
  var code = $("#phone_code").val();
  if (phone == "" || code == "") {
    $("#dialog2").show().on('click', '.weui_btn_dialog', function() {
      $("#dialog2").off('click').hide();
      $("#phone")[0].foucus();
      });
    return;
  } else {
  }

  $('#loadingToast').show();
  $.getJSON("/verifyPhone?phone=" + phone + "&code=" + code, function(response) {
    // alert(JSON.stringify(response));
    $('#loadingToast').hide();
    if (response.err) {
    $("#sms_dialog_db").text("操作出错: " + response.errMsg)
    $("#dialog_sms_ok").show().on('click', '.weui_btn_dialog', function() {
      $("#dialog_sms_ok").off('click').hide();
      });
    } else {
    $("#dialog_confirm").show().on('click', '.weui_btn_dialog', function() {
      $("#dialog_confirm").off('click').hide();
      window.location.href="/point"
      });

    }
    })
}
</script>
    </body>
  </html>
